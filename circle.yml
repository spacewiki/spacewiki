machine:
  node:
    version: v6.1.0
  services:
    - docker
  environment:
    PATH: $HOME/spacewiki/node_modules/.bin:$PATH

general:
  artifacts:
    - linter.html

dependencies:
  override:
    - docker pull fedora:24
    - pip install -e .[test]
    - make npm

test:
  override:
    - make test
    - docker build -t spacewiki:app .
    - docker run -v `pwd`:/spacewiki/app/ spacewiki:app make docker_test
    - docker run -d -p 5000:5000 spacewiki:app
    - sleep 5
    - curl http://localhost:5000/
deployment:
  docker:
    branch: master
    commands:
      - docker login -u $DOCKER_USERNAME -e $DOCKER_EMAIL -p $DOCKER_PASSWORD
      - docker tag spacewiki:app spacewiki/spacewiki
      - docker push spacewiki/spacewiki
